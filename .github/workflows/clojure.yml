name: Clojure CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install chrome and chrome driver
      run: |
        sudo apt update 
        sudo apt install -y unzip xvfb libxi6 libgconf-2-4
        sudo curl -sS -o - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add 
        sudo bash -c "echo 'deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main' >> /etc/apt/sources.list.d/google-chrome.list" 
        sudo apt -y update 
        sudo apt -y install google-chrome-stable 
        BROWSER_MAJOR=$(google-chrome --version | sed 's/Google Chrome \([0-9]*\).*/\1/g') && \
          wget https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${BROWSER_MAJOR} -O chrome_version && \
          wget https://chromedriver.storage.googleapis.com/`cat chrome_version`/chromedriver_linux64.zip && \
          unzip chromedriver_linux64.zip && \
          mv chromedriver /usr/local/bin/ && \
        DRIVER_MAJOR=$(chromedriver --version | sed 's/ChromeDriver \([0-9]*\).*/\1/g') && \
          echo "chrome version: $BROWSER_MAJOR" && \
          echo "chromedriver version: $DRIVER_MAJOR" && \
        if [ $BROWSER_MAJOR != $DRIVER_MAJOR ]; then echo "VERSION MISMATCH"; exit 1; fi
    - name: Install dependencies
      run: lein deps
    - name: Run tests
      run: lein test
